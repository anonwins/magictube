#!/bin/bash
#    ____ ___  ____ _____ _(_)____/ /___  __/ /_  ___ 
#   / __ `__ \/ __ `/ __ `/ / ___/ __/ / / / __ \/ _ \
#  / / / / / / /_/ / /_/ / / /__/ /_/ /_/ / /_/ /  __/
# /_/ /_/ /_/\__,_/\__, /_/\___/\__/\__,_/_.___/\___/ 
#                 /____/                              
# magictube v2.4 by anonwins
# https://github.com/anonwins/magictube
#
# CONFIG #################################################################
#
# Uncomment this to explicitly set the download directory
# By default, your working directory is used
# cd "/Music/magictube/"
#
# SCRIPT #################################################################

counter=1

while :
do

  # ask for input
  read -p "$counter. " query

  # search on youtube
  user_agent="Mozilla/5.0 (iPhone; CPU iPhone OS 6_1_3 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) CriOS/28.0.1500.12 Mobile/10B329 Safari/8536.25"
  results=$(curl --silent -A "$user_agent" -G --data-urlencode "sp=mAEA" --data-urlencode "search_query=$query" --data-urlencode "app=m.html" --data-urlencode "persist_app=1" https://m.youtube.com/results)
  
  # get first video_id
  video_id=$(echo $results | awk -F 'videoId' '{print $2}' | head -c20 | cut -c 10-)

  # get song filename & title
  filename=$(youtube-dl -no-part --no-warnings --get-filename -f 140 -o "%(title)s.%(ext)s" https://www.youtube.com/watch?v=$video_id)
  title=${filename::-4}

  # print the song title
  echo -en "\033[1A\033[2K"
  echo "$counter. $title"

  # delete temp file if script gets interrupted & exit properly
  trap "[ -f \"$filename.part\" ] && rm -f \"$filename.part\"; echo \"\"; exit 130" INT

  # download the audio stream in m4a format
  youtube-dl -no-part --no-warnings --no-mtime -f 140 -o "%(title)s.%(ext)s" https://www.youtube.com/watch?v=$video_id &>/dev/null

  # open the song in detached process
  setsid xdg-open "./$filename" > /dev/null 2>&1

  ((counter++))

done
